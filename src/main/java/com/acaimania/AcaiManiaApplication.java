package main.java.com.acaimania;

import main.java.com.acaimania.model.*;
import main.java.com.acaimania.model.decorator.*;
import main.java.com.acaimania.service.DeliveryService;
import main.java.com.acaimania.strategy.*;
import java.io.IOException;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.time.LocalDateTime;
import java.util.Random;
import java.util.Scanner;

/**
 * Classe com os menus da aplica√ß√£o.
 *
 * @author Jo√£o Guedes.
 */
public class AcaiManiaApplication {

    /**
     * M√©todo que inicia a aplica√ß√£o.
     */
    public void start() {
        this.showAcaiOptionsMenu();
    }

    /**
     * M√©todo que exibe um menu de entrada de dados.
     *
     * @param menu Menu que ser√° exibido.
     *
     * @param validInputs Entradas v√°lidas.
     *
     * @return Entrada que o usu√°rio digitou no menu.
     */
    private String showInputMenu(StringBuilder menu, String validInputs) {
        Scanner scanner = new Scanner(System.in);
        String userInput;
        validInputs = validInputs.toUpperCase();
        do {
            this.clearScreen();
            System.out.print(menu);
            userInput = scanner.next();
            if (userInput.length() > 1 || !validInputs.contains(userInput.toUpperCase())) {
                this.showInvalidInputMessage();
            }
            else {
                this.showEndLine();
                return userInput;
            }
        } while(true);
    }

    /**
     * M√©todo que exibe um menu onde o usu√°rio poder√° escolher se deseja uma por√ß√£o pequena ou uma
     * por√ß√£o grande de a√ßa√≠.
     */
    private void showAcaiOptionsMenu() {
        StringBuilder acaiOptionsMenu = this.acaiOptionsMenu();
        String validOptions = "12X";
        String userOption = this.showInputMenu(acaiOptionsMenu, validOptions);
        this.triggerAcaiOptionsMenuOption(userOption);
    }

    /**
     * M√©todo que retorna um StringBuilder contendo as op√ß√µes de a√ßa√≠ dispon√≠veis.
     *
     * @return Retorna um StringBuilder contendo as op√ß√µes de a√ßa√≠ dispon√≠veis.
     */
    private StringBuilder acaiOptionsMenu() {
        Acai smallAcai = SmallAcai.getInstance();
        Acai bigAcai = BigAcai.getInstance();
        StringBuilder sb = new StringBuilder();
        sb.append("üç® üç® üç® üç® üç® üç® A√áA√ç MANIA üç® üç® üç® üç® üç® üç®\n\n");
        sb.append("       Escolha uma das op√ß√µes de tamanho:\n\n");
        sb.append("\n    [1] - A√ßa√≠ no copo (").append(smallAcai.getQuantity()).append(") -> R$")
                .append(smallAcai.getPrice());
        sb.append("\n    [2] - A√ßa√≠ na tigela (").append(bigAcai.getQuantity()).append(") -> R$")
                .append(bigAcai.getPrice());
        sb.append("\n    [x] - Sair");
        sb.append("\n\n                  Op√ß√£o: ");
        return sb;
    }

    /**
     * M√©todo que aciona uma op√ß√£o do menu de op√ß√µes de a√ßa√≠ conforme a escolha que o usu√°rio fez.
     *
     * @param userOption Op√ß√£o do usu√°rio.
     */
    private void triggerAcaiOptionsMenuOption(String userOption) {
        switch (userOption.toUpperCase()) {
            case "1" -> this.showAdditionalOptionsMenu(SmallAcai.getInstance());
            case "2" -> this.showAdditionalOptionsMenu(BigAcai.getInstance());
            case "X" -> this.showByeMessage();
            default -> throw new IllegalArgumentException("Invalid option.");
        }
    }

    /**
     * M√©todo que exibe um menu onde o usu√°rio poder√° escolher quais adicionais ele deseja adicionar
     * ao seu a√ßa√≠.
     *
     * @param userAcai A√ßa√≠ do usu√°rio.
     */
    private void showAdditionalOptionsMenu(Acai userAcai) {
        StringBuilder additionalOptionsMenu = this.additionalOptionsMenu();
        String validOptions = "123456SX";
        String userOption = this.showInputMenu(additionalOptionsMenu, validOptions);
        this.triggerAdditionalOptionsMenuOption(userAcai, userOption);
    }

    /**
     * M√©todo que retorna um StringBuilder contendo as op√ß√µes de adicionais dispon√≠veis.
     *
     * @return Retorna um StringBuilder contendo as op√ß√µes de adicionais dispon√≠veis.
     */
    private StringBuilder additionalOptionsMenu() {
        StringBuilder sb = new StringBuilder();
        sb.append("üç® üç® üç® üç® üç® üç® A√áA√ç MANIA üç® üç® üç® üç® üç® üç®\n");
        sb.append("\n     Escolha uma das op√ß√µes de adicionais:\n");
        sb.append("\n        [1] - Leite Condesado -> R$").append(CondensedMilk.ADDITIONAL_PRICE);
        sb.append("\n        [2] - Leite em p√≥ -> R$").append(MilkPowder.ADDITIONAL_PRICE);
        sb.append("\n        [3] - Pa√ßoca -> R$").append(Pacoca.ADDITIONAL_PRICE);
        sb.append("\n        [4] - Granola -> R$").append(Muesli.ADDITIONAL_PRICE);
        sb.append("\n        [5] - Kiwi -> R$").append(Kiwi.ADDITIONAL_PRICE);
        sb.append("\n        [6] - Morango -> R$").append(Strawberry.ADDITIONAL_PRICE);
        sb.append("\n        [s] - Sem mais adicionais");
        sb.append("\n        [x] - Sair");
        sb.append("\n\n                 Op√ß√£o: ");
        return sb;
    }

    /**
     * M√©todo que aciona uma op√ß√£o do menu de op√ß√µes de adicionais conforme a escolha que o usu√°rio fez.
     *
     * @param userAcai A√ßa√≠ do usu√°rio.
     *
     * @param userOption Op√ß√£o do usu√°rio.
     */
    private void triggerAdditionalOptionsMenuOption(Acai userAcai, String userOption) {
        switch (userOption.toUpperCase()) {
            case "X" -> this.showByeMessage();
            case "S" -> this.showDeliveryOptionsMenu(userAcai);
            default -> {
                userAcai = this.addAdditional(userAcai, userOption);
                this.showAdditionalOptionsMenu(userAcai);
            }
        }
    }

    /**
     * M√©todo que adiciona um adicional ao a√ßa√≠ conforme a escolha do usu√°rio.
     *
     * @param userAcai A√ßa√≠ do usu√°rio.
     *
     * @param additionalOption Op√ß√£o de adicional que o usu√°rio escolheu.
     *
     * @return Retorna um a√ßa√≠ conforme a op√ß√£o de adicional do usu√°rio.
     */
    private Acai addAdditional(Acai userAcai, String additionalOption) {
        return switch (additionalOption.toUpperCase()) {
            case "1" -> new CondensedMilk(userAcai);
            case "2" -> new MilkPowder(userAcai);
            case "3" -> new Pacoca(userAcai);
            case "4" -> new Muesli(userAcai);
            case "5" -> new Kiwi(userAcai);
            case "6" -> new Strawberry(userAcai);
            default -> throw new IllegalArgumentException("Unknown additional option.");
        };
    }

    /**
     * M√©todo que exibe um menu onde o usu√°rio poder√° escolher o servi√ßo de entrega que ele deseja.
     *
     * @param userAcai A√ßa√≠ do usu√°rio.
     */
    private void showDeliveryOptionsMenu(Acai userAcai) {
        StringBuilder deliveryOptionsMenu = this.deliveryOptionsMenu();
        String validOptions = "1234X";
        String userOption = this.showInputMenu(deliveryOptionsMenu, validOptions);
        this.triggerDeliveryOptionsMenuOption(userAcai, userOption);
    }

    /**
     * M√©todo que retorna um StringBuilder contendo todas as op√ß√µes de servi√ßo de entrega.
     *
     * @return Retorna um StringBuilder contendo todas as op√ß√µes de servi√ßo de entrega.
     */
    private StringBuilder deliveryOptionsMenu() {
        StringBuilder sb = new StringBuilder();
        sb.append("üç® üç® üç® üç® üç® üç® A√áA√ç MANIA üç® üç® üç® üç® üç® üç®\n");
        sb.append("\n       Escolha uma das op√ß√µes de entrega:\n");
        sb.append("\n         [1] - Ifood -> R$").append(this.getDeliveryServiceOption("1").calculateDeliveryPrice());
        sb.append("\n         [2] - NineNineFood -> R$").append(this.getDeliveryServiceOption("2").calculateDeliveryPrice());
        sb.append("\n         [3] - UberEats -> R$").append(this.getDeliveryServiceOption("3").calculateDeliveryPrice());
        sb.append("\n         [4] - YourSelfFood -> R$").append(this.getDeliveryServiceOption("4").calculateDeliveryPrice());
        sb.append("\n         [x] - Sair");
        sb.append("\n\n                   Op√ß√£o: ");
        return sb;
    }

    /**
     * M√©todo que aciona uma op√ß√£o do menu de op√ß√µes de entrega conforme a escolha que o usu√°rio fez.
     *
     * @param userAcai A√ßa√≠ do usu√°rio.
     *
     * @param userOption Op√ß√£o do usu√°rio.
     */
    private void triggerDeliveryOptionsMenuOption(Acai userAcai, String userOption) {
        if (userOption.equalsIgnoreCase("X")) {
            this.showByeMessage();
            return;
        }
        DeliveryService deliveryServiceChosed = this.getDeliveryServiceOption(userOption);
        double deliveryPrice = deliveryServiceChosed.calculateDeliveryPrice();
        this.showFinalizeOrderMenu(userAcai, deliveryPrice);
    }

    /**
     * M√©todo que retorna uma implementa√ß√£o de um DeliveryService conforme a op√ß√£o do usu√°rio.
     *
     * @param userOption Op√ß√£o do usu√°rio.
     *
     * @return Retorna uma implementa√ß√£o de um DeliveryService conforme a op√ß√£o do usu√°rio.
     */
    private DeliveryService getDeliveryServiceOption(String userOption) {
        return switch (userOption) {
            case "1" -> new DeliveryService(IFood.getInstance());
            case "2" -> new DeliveryService(NineNineFood.getInstance());
            case "3" -> new DeliveryService(UberEats.getInstance());
            case "4" -> new DeliveryService(YourSelfFood.getInstance());
            default -> throw new IllegalArgumentException("Unknown delivery service.");
        };
    }

    /**
     * M√©todo que exibe o menu de finaliza√ß√£o do pedido.
     * 
     * @param userAcai A√ßa√≠ do usu√°rio.
     *             
     * @param deliveryPrice Pre√ßo cobrado pelo servi√ßo de entrega.
     */
    private void showFinalizeOrderMenu(Acai userAcai, double deliveryPrice) {
        double totalPrice = userAcai.getPrice() + deliveryPrice;
        StringBuilder finalizeOrderMenu = this.finalizeOrderMenu(userAcai, deliveryPrice, totalPrice);
        String validOptions = "SN";
        String userOption = this.showInputMenu(finalizeOrderMenu, validOptions);
        this.triggerFinalizeOrderMenuOption(userAcai, deliveryPrice, totalPrice, userOption);
    }

    /**
     * M√©todo que retorna um StringBuilder contendo o menu de finaliza√ß√£o do pedido.
     *
     * @param userAcai A√ßa√≠ do usu√°rio.
     *
     * @param deliveryPrice Pre√ßo cobrado pelo servi√ßo de entrega.
     *
     * @param totalPrice Valor total do pedido (a√ßa√≠ + taxa de entrega).
     *
     * @return Retorna um StringBuilder contendo o menu de finaliza√ß√£o do pedido.
     */
    private StringBuilder finalizeOrderMenu(Acai userAcai, double deliveryPrice, double totalPrice) {
        StringBuilder sb = new StringBuilder();
        sb.append("üç® üç® üç® üç® üç® üç® A√áA√ç MANIA üç® üç® üç® üç® üç® üç®\n");
        sb.append("\nüîò Preparando o pedido");
        sb.append("\n\n".concat(userAcai.list()));
        sb.append("\n\nüîò A√ßa√≠ pronto\n");
        sb.append("\n-----------------------------------------------");
        sb.append("\n             > Pre√ßo A√ßa√≠: R$").append(userAcai.getPrice());
        sb.append("\n             > Pre√ßo Entrega: R$").append(deliveryPrice);
        sb.append("\n-----------------------------------------------");
        sb.append("\n             VALOR TOTAL: R$").append(totalPrice);
        sb.append("\n-----------------------------------------------");
        sb.append("\n\n           Confirmar compra [s/n]? ");
        return sb;
    }

    /**
     * M√©todo que aciona uma a√ß√£o do menu de finaliza√ß√£o do pedido conforme a op√ß√£o do usu√°rio.
     *
     * @param userAcai A√ßa√≠ do usu√°rio.
     *
     * @param deliveryPrice Pre√ßo cobrado pelo servi√ßo de entrega.
     *
     * @param totalPrice Valor total do pedido (a√ßa√≠ + taxa de entrega).
     *
     * @param userOption Op√ß√£o do usu√°rio.
     */
    private void triggerFinalizeOrderMenuOption(Acai userAcai, Double deliveryPrice, Double totalPrice, String userOption) {
        if (userOption.equalsIgnoreCase("N")) {
            this.showCancelOrderMessage();
        }
        else {
            String receiptPath = this.generateReceipt(userAcai, deliveryPrice, totalPrice);
            this.showReceiptMenu(receiptPath);
        }
    }

    /**
     * M√©todo que exibe um menu com os dados da nota fiscal e o tempo de entrega do pedido do usu√°rio.
     *
     * @param receiptPath Caminho de diret√≥rio da nota fiscal gerada.
     */
    private void showReceiptMenu(String receiptPath) {
        StringBuilder receiptMenu = this.receiptMenu(receiptPath);
        String validOptions = "SN";
        String userOption = this.showInputMenu(receiptMenu, validOptions);
        this.triggerReceiptMenuOption(userOption);
    }

    /**
     * M√©todo que retorna um StringBuilder contendo o menu de recibo da compra.
     *
     * @param receiptPath Caminho de diret√≥rio da nota fiscal.
     *
     * @return Retorna um StringBuilder contendo o menu de recibo da compra.
     */
    private StringBuilder receiptMenu(String receiptPath) {
        StringBuilder sb = new StringBuilder();
        int minutes = new Random().nextInt(15,36);
        sb.append("üç® üç® üç® üç® üç® üç® A√áA√ç MANIA üç® üç® üç® üç® üç® üç®");
        sb.append("\n\nObrigado pela sua compra! ü§©");
        sb.append("\n\nSeu pedido ser√° entregue em ").append(minutes).append(" minutos.");
        sb.append("\n\nSua nota fiscal foi gerada e est√° no arquivo de");
        sb.append("\nnome ").append(receiptPath).append(".");
        sb.append("\n\nEsse √© um mostru√°rio da sua nota ‚¨á\n\n");
        sb.append(this.getReceipt(receiptPath));
        sb.append("\n          Comprar novamente [s/n]? ");
        return sb;
    }

    /**
     * M√©todo que aciona uma a√ß√£o do menu de recibo do pedido conforme a op√ß√£o do usu√°rio.
     *
     * @param userOption Op√ß√£o do usu√°rio.
     */
    private void triggerReceiptMenuOption(String userOption) {
        switch (userOption.toUpperCase()) {
            case "S" -> this.showAcaiOptionsMenu();
            case "N" -> this.showByeMessage();
            default -> throw new IllegalArgumentException("Unknown user option: ".concat(userOption));
        }
    }

    /**
     * M√©todo que gera a nota fiscal da compra do usu√°rio.
     *
     * @param userAcai A√ßa√≠ comprado pelo usu√°rio.
     *
     * @param deliveryPrice Pre√ßo cobrado pelo servi√ßo de entrega.
     *
     * @param totalPrice Valor total do pedido (a√ßa√≠ + taxa de entrega).
     *
     * @return Retorna o caminho de diret√≥rio da nota fiscal do usu√°rio.
     */
    private String generateReceipt(Acai userAcai, Double deliveryPrice, Double totalPrice) {
        LocalDateTime dateOfOrder = LocalDateTime.now();
        String path = dateOfOrder.toString().concat(".NFS-e").replace(":", ";");
        try (FileWriter fileWriter = new FileWriter(path, false);
             BufferedWriter bufferedWriter = new BufferedWriter((fileWriter));
             PrintWriter printWriter = new PrintWriter(bufferedWriter)
        ) {
            StringBuilder receiptDescription = new StringBuilder();
            receiptDescription.append("Data da Compra: ").append(dateOfOrder).append("\n");
            receiptDescription.append(userAcai.list());
            receiptDescription.append("\nPre√ßo do A√ßa√≠: R$").append(userAcai.getPrice());
            receiptDescription.append("\nPre√ßo da Entrega: R$").append(deliveryPrice);
            receiptDescription.append("\nPre√ßo Total: R$").append(totalPrice).append("\n");
            printWriter.append(receiptDescription);
            return path;
        }
        catch (IOException e) {
            throw new RuntimeException("Error generating receipt.");
        }
    }

    /**
     * M√©todo que retorna os dados da nota fiscal (arquivo txt) gerada do pedido do usu√°rio.
     *
     * @param path Caminho de diret√≥rio da nota fiscal.
     *
     * @return Retorna um StringBuilder contendo os dados da nota fiscal (arquivo txt) gerada do pedido do usu√°rio.
     */
    private StringBuilder getReceipt(String path) {
        try (BufferedReader reader = new BufferedReader(new FileReader(path))) {
            StringBuilder sb = new StringBuilder();
            String line = reader.readLine();
            while (line != null) {
                sb.append(line.concat("\n"));
                line = reader.readLine();
            }
            return sb;
        }
        catch (IOException e) {
            throw new RuntimeException("Error reading receipt.");
        }
    }

    /**
     * M√©todo que exibe uma mensagem caso o usu√°rio opte por n√£o finalizar a compra.
     */
    private void showCancelOrderMessage() {
        this.clearScreen();
        System.out.println("üç® üç® üç® üç® üç® üç® A√áA√ç MANIA üç® üç® üç® üç® üç® üç®\n\n\n\n");
        System.out.println("    Que pena, voc√™ n√£o finalizou sua compra.            ");
        System.out.println("             Esperamos que volte!                       ");
        System.out.println("\n\n\n\nüç® üç® üç® üç® üç® üç® üç® üç®  üç® üç® üç® üç® üç® üç® üç® ");
        this.sleep(1000);
    }

    /**
     * M√©todo que exibe uma mensagem de despedida da aplica√ß√£o.
     */
    private void showByeMessage() {
        this.clearScreen();
        System.out.println("üç® üç® üç® üç® üç® üç® A√áA√ç MANIA üç® üç® üç® üç® üç® üç®\n\n\n\n");
        System.out.println("         J√° est√° indo embora? Que pena.                 ");
        System.out.println("           Esperamos te ver novamente!                  ");
        System.out.println("\n\n\n\nüç® üç® üç® üç® üç® üç® üç® üç®  üç® üç® üç® üç® üç® üç® üç®");
        this.sleep(1000);
    }

    /**
     * M√©todo que exibe uma mensagem de entrada inv√°lida.
     */
    private void showInvalidInputMessage() {
        System.out.print("\n            ‚ùå Entrada inv√°lida ‚ùå\n");
        this.showEndLine();
    }

    /**
     * M√©todo que exibe as √∫ltimas linhas de um menu.
     */
    private void showEndLine() {
        System.out.println("\nüç® üç® üç® üç® üç® üç® üç® üç®  üç® üç® üç® üç® üç® üç® üç®");
        this.sleep(1500);
    }

    /**
     * M√©todo com a fun√ß√£o de "limpar" a tela do console.
     */
    private void clearScreen() {
        System.out.println("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n");
    }

    /**
     * M√©todo que faz uma "pausa" no programa.
     *
     * @param millis Tempo em milissegundos em que o programa ser√° "pausado".
     */
    private void sleep(int millis) {
        try {
            Thread.sleep(millis);
        } catch (InterruptedException ignored) {}
    }

    public static void main(String[] args) {
        AcaiManiaApplication acaiManiaApp = new AcaiManiaApplication();
        acaiManiaApp.start();
    }

}